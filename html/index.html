<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Whistle Synth</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-27645543-1"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'UA-27645543-1');</script></head>

<style>
  .osc {
    margin-top: 0.5em;
    border: 1px solid black;
    border-radius: 0.25em;
  }
  .osc > * {
    margin: 0.5em;
  }
  #instructions {
    border: 1px solid black;
    border-radius: 0.25em;
    margin: 1em;
    padding-left: 1em;
    max-with: 40em;
  }
  input[type=text] {
    width: 4em;
  }
  button {
    margin-top: 0.1em;
  }
  .error {
    max-width: 40em;
    border: 2px solid red;
    border-radius: 0.25em;
    margin: 1em;
    padding: 1em;
    max-with: 40em;
    display: none;
  }
  #controls {
    display: none;
  }
</style>

<style>
.headfoot ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
}
.headfoot li {
  display: inline;
  margin-left: 5px;
  margin-right: 5px;
}
</style>

<body>
  <div class=headfoot>
  <ul>
  <li><a href="/">Jeff Kaufman</a></li>
  <li><a href="/news/all">Posts</a></li>
  <li><a href="/news.rss">RSS</a></li>
  <li><a href="/contact">Contact</a></li>
  </div>
  <hr>

<h1>Whistle Synth</h1>

<div id=isMobile class=error>
  Mobile browsers are not recommended: they are generally not fast enough.  You're welcome to continue if you want to, but it probably won't sound good and may not work at all.
</div>

<div id=noAudioWorklet class=error>
  Your browser doesn't support AudioWorklet, which this relies on.  This isn't going to work.  Try Firefox, Chrome, or Edge instead?
</div>

<div id=instructions>
<h2>Instructions</h2>
<p>

This is a synthesizer that you control by whistling (or singing).  To begin, put on headphones, click "start", and whistle.

  <p>

Works best in Firefox, but also works in Chrome and Edge.

 <p>

<button id=startButton>start</button>
                                                     
</div>
<div id=controls>
<button id=muteAll>mute</button> <button id=reset>reset</button>

<p>
Whistling Voices:
  <button class=voice>w1</button>
  <button class=voice>w2</button>
  <button class=voice>w3</button>
  <button class=voice>w4</button>
<br>
Singing Voices (sing "doooo"):
  <button class=voice>s1</button>
  <button class=voice>s2</button>

<p>

  <table>
  <tr><td><label for=volume>volume:</label><td><input type=text id=volume value=1>
      <td>Output volume.  Higher numbers are louder.
  <tr><td><label for=alpha>alpha:</label><td><input type=text id=alpha value=0.1>
      <td>Simple low-pass filter.  1 means no filter, lower numbers filter more high harmonics.
  <tr><td><label for=rangeLow>rangeLow:</label><td><input type=text id=rangeLow value=500>
    <td>Minimum frequency to detect (Hz).
  <tr><td><label for=rangeHigh>rangeHigh:</label><td><input type=text id=rangeHigh value=3200>
    <td>Maximum frequency to detect (Hz).
</table>

  <p>


  <button id=addOsc>add oscillator</button>

<div id=oscs></div>
</div>

<div style=text-align:right>
<a href="/p/better-whistle-synth">details</a>
</div>


<script>
if (!window.AudioWorklet) {
  window.noAudioWorklet.style.display = "block";
}

if (navigator.userAgent.includes("Android") ||
    navigator.userAgent.includes("iOS")) {
  window.isMobile.style.display = "block";
}

function clear() {
  while (oscs.children.length) {
    oscs.removeChild(oscs.children[0]);
  }
  configChange();
}
reset.addEventListener("click", () => {
  window.volume.value = 1;
  window.alpha.value = 0.1;
  window.rangeLow.value = 500;
  window.rangeHigh.value = 3200;
  clear();
});

document.querySelectorAll(".voice").forEach((v) => {
  v.addEventListener("click", (e) => {
    setVoice(e.target.innerText);
  });
});

function setVoice(voice) {
  clear();
  volume.value = 1;
  alpha.value = 0.1;
  rangeLow.value = 500;
  if (voice == "w1") {
    volume.value = 0.9;
    alpha.value = 0.01;
    addOscillator({
      "fn": "sin",
      "volume": 1,
      "speed": 0.25,
      "cycle": 0.25,
      "mod": 2,
      "duration": 3,
      "mute": false,
    });
    addOscillator({
      "fn": "sin",
      "volume": 1,
      "speed": 0.125,
      "cycle": 0.125,
      "mod": 2,
      "duration": 3,
      "mute": false,
    });
  } else if (voice == "w2") {
    addOscillator({
      "fn": "sin",
      "volume": 1,
      "speed": 2,
      "cycle": 2,
      "mod": 2,
      "duration": 3,
      "mute": false,
      });
    addOscillator({
      "fn": "sin",
      "volume": 1,
      "speed": 3,
      "cycle": 2,
      "mod": 2,
      "duration": 3,
      "mute": false,
    });
    addOscillator({
      "fn": "sin",
      "volume": 1,
      "speed": 4,
      "cycle": 2,
      "mod": 2,
      "duration": 3,
      "mute": false,
    });
    addOscillator({
      "fn": "sin",
      "volume": 1,
      "speed": 5,
      "cycle": 2,
      "mod": 2,
      "duration": 3,
      "mute": false,
    });
    addOscillator({
      "fn": "sin",
      "volume": 1,
      "speed": 6,
      "cycle": 2,
      "mod": 2,
      "duration": 3,
      "mute": false,
    });
  } else if (voice == "w3") {
    volume.value = 0.6;
    alpha.value = 0.01;
    addOscillator({
      "fn": "sqr",
      "volume": 1,
      "speed": 0.5,
      "cycle": 0.5,
      "mod": 2,
      "duration": 3,
        "mute": false,
    });
    addOscillator({
      "fn": "sin",
      "volume": 1,
      "speed": 0.25,
      "cycle": 0.25,
      "mod": 2,
      "duration": 3,
      "mute": false,
    });
    addOscillator({
      "fn": "sin",
      "volume": 1,
      "speed": 0.125,
      "cycle": 0.125,
      "mod": 2,
      "duration": 3,
      "mute": false,
    });
  } else if (voice == "w4") {
    addOscillator({
      "fn": "sin",
      "volume": 1,
      "speed": 0.5,
      "cycle": 0.5,
      "mod": 4,
      "duration": 3,
      "mute": false,
    });
    addOscillator({
      "fn": "sin",
      "volume": 1,
      "speed": 0.5,
      "cycle": 1,
      "mod": 2,
      "duration": 3,
      "mute": false,
    });
    addOscillator({
      "fn": "sin",
      "volume": 1,
      "speed": 0.5,
      "cycle": 0.25,
      "mod": 3,
      "duration": 3,
      "mute": false,
    });
  } else if (voice == "s1") {
    volume.value = 0.6;
    alpha.value = 0.01;
    rangeLow.value = 80;
    
    addOscillator({
      "fn": "sin",
      "volume": 1,
      "speed": 0.5,
      "cycle": 1,
      "mod": 2,
      "duration": 3,
      "mute": false,
    });
  } else if (voice == "s2") {
    volume.value = 0.6;
    alpha.value = 0.01;
    rangeLow.value = 80;
    
    addOscillator({
      "fn": "sqr",
      "volume": 1,
      "speed": 0.5,
      "cycle": 0.5,
      "mod": 2,
      "duration": 3,
      "mute": false,
    });
    addOscillator({
      "fn": "sin",
      "volume": 1,
      "speed": 0.25,
      "cycle": 1,
      "mod": 2,
      "duration": 3,
      "mute": false,
    });
  }
}

var playerNode;
var audioCtx;
var micStream;
var micNode;

async function start() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)({latencyHint: 0});
  micStream = await navigator.mediaDevices.getUserMedia({
    audio: {
      echoCancellation: false,
      latency: 0,
      noiseSuppresion: false,
      autoGainControl: false,
    },    
  });
  micNode = new MediaStreamAudioSourceNode(audioCtx, { mediaStream: micStream });
  await audioCtx.audioWorklet.addModule('combined.js?cb=' + Math.random());
  playerNode = new AudioWorkletNode(audioCtx, 'synth');
  micNode.connect(playerNode)
  playerNode.connect(audioCtx.destination);
  playerNode.port.onmessage = configChange;
}

function getAlpha() {
  if (parseFloat(alpha.value) > 1 || parseFloat(alpha.value) < 0.0000001) {
    alpha.value = 1;
  }
  return parseFloat(alpha.value);
}

function loadConfig() {
  let hash = window.location.hash;
  if (hash) {
    hash = hash.substring(1);
    if (hash) {
      config = JSON.parse(decodeURIComponent(hash));
      
      if (config.alpha) alpha.value = config.alpha;
      if (config.volume) volume.value = config.volume;
      if (config.rangeLow) rangeLow.value = config.rangeLow;
      if (config.rangeHigh) rangeHigh.value = config.rangeHigh;
      
      for (let i = 0; i < config.oscConfigs.length; i++) {
        addOscillator(config.oscConfigs[i]);
      }
      return;
    }
  }
  setVoice("w1");
}
window.onload = () => {
  try {
    loadConfig();
  } catch (e) {
    window.location.hash = "";
    window.location.reload();
  }
}

function getConfig() {
  return {
    alpha: getAlpha(),
    volume: parseFloat(volume.value),
    rangeLow: parseFloat(rangeLow.value),
    rangeHigh: parseFloat(rangeHigh.value),
    oscConfigs: getOscConfigs(),
  }
}

function getOscConfigs() {
  const oscConfigs = [];
  for (let i = 0; i < window.oscs.children.length; i++) {
    const osc = window.oscs.children[i];
    oscConfigs.push({
      fn: osc.fnToggle.innerText,
      volume: parseFloat(osc.volume.value),
      speed: parseFloat(osc.speed.value),
      cycle: parseFloat(osc.cycle.value),
      mod: parseInt(osc.mod.value, 10),
      duration: parseInt(osc.duration.value, 10),
      mute: osc.mute.innerText === "M",
    });
  }
  return oscConfigs;
}

function configChange() {
  const config = getConfig();
  window.location.hash = JSON.stringify(config);
  if (playerNode) {
    playerNode.port.postMessage(config);
  }
}

var running = false;
startButton.addEventListener("click", function() {
  window.instructions.style.display = "none";
  window.controls.style.display = "block";
  running = true;
  start();
});

muteAll.addEventListener("click", function() {
  if (running) {
    playerNode.disconnect(audioCtx.destination); 
    muteAll.textContent = "unmute";
    running = false;
  } else {
    playerNode.connect(audioCtx.destination);
    muteAll.textContent = "mute";
    running = true; 
  }
});

const inputs = document.querySelectorAll("input");
for (let i = 0; i < inputs.length; i++) {
  inputs[i].addEventListener("change", configChange);
}
  
addOsc.addEventListener("click", () => {
  addSimpleOscillator(1);
});

function addSimpleOscillator(scale) {
  addOscillator({
    volume: 1,
    speed: 1/scale/2,
    cycle: 1,
    mod: 2,
    duration: 3,
    fn: "sin",
    mute: false,
  });
}

TEXT_PARAMS = ["volume", "speed", "cycle", "mod", "duration"];

function addOscillator(oscConfig) {
  const osc = document.createElement("div");
  osc.className = "osc";

  const fnToggle = document.createElement("button");
  fnToggle.innerText = oscConfig.fn;
  fnToggle.addEventListener("click", (e) => {
    const osc = e.target.parentElement;
    const index = [...osc.parentElement.children].indexOf(osc);
    fnToggle.innerText = {
      "sin": "sqr",
      "sqr": "sin",
    }[fnToggle.innerText];
    configChange();
  });
  osc.fnToggle = fnToggle;
  osc.appendChild(fnToggle);

  for (let i = 0; i < TEXT_PARAMS.length; i++) {
    const param = TEXT_PARAMS[i];

    const label = document.createElement("label");
    label.innerText = param + ":";
    osc.appendChild(label);
    
    const input = document.createElement("input");
    input.type = "text";
    input.value = ""+oscConfig[param];
    input.addEventListener("change", configChange);
    osc[param] = input;
    osc.appendChild(input);
  }

  const mute = document.createElement("button");
  mute.innerText = oscConfig.mute ? "M" : "m";
  mute.addEventListener("click", (e) => {
    const osc = e.target.parentElement;
    const index = [...osc.parentElement.children].indexOf(osc);
    mute.innerText = (mute.innerText == "m") ? "M" : "m";
    configChange();
  });
  osc.mute = mute;
  osc.appendChild(mute);
  
  const del = document.createElement("button");
  del.innerText = "x";
  del.addEventListener("click", (e) => {
    const osc = e.target.parentElement;
    const index = [...osc.parentElement.children].indexOf(osc);
    osc.parentElement.removeChild(osc);
    configChange();
  });
  osc.appendChild(del);

  oscs.appendChild(osc);
  configChange();
}
</script>
</html>
